files:
  "/opt/elasticbeanstalk/hooks/appdeploy/pre/01_fetch_ssm_parameters.sh":
    mode: "000755"
    owner: root
    group: root
    content: |
      #!/bin/bash

      echo "Set AWS region"
      sudo aws configure set default.region ap-southeast-1

      echo "Fetching CLIENT_ID from SSM"
      CLIENT_ID=$(sudo aws ssm get-parameter --name STAGING_CLIENT_ID --with-decryption --query "Parameter.Value" --output text)
      sudo tee -a /opt/elasticbeanstalk/deployment/env
      echo "Exported CLIENT_ID"

      echo "Fetching CLIENT_SECRET from SSM"
      CLIENT_SECRET=$(sudo aws ssm get-parameter --name STAGING_CLIENT_SECRET --with-decryption --query "Parameter.Value" --output text)
      sudo tee -a /opt/elasticbeanstalk/deployment/env
      echo "Exported CLIENT_SECRET"

commands:
  01_fetch_ssm_parameters:
    command: "/opt/elasticbeanstalk/hooks/appdeploy/pre/01_fetch_ssm_parameters.sh"
    ignoreErrors: false
