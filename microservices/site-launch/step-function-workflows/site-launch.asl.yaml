Comment: Site launch state machine
StartAt: Parallel
States:
  Parallel:
    Type: Parallel
    Branches:
      - StartAt: General domain validation
        States:
          General domain validation:
            Type: Task
            Resource: arn:aws:states:::lambda:invoke
            OutputPath: $.Payload
            InputPath: $.Records[0].body
            Parameters:
              FunctionName: "arn:aws:lambda:${aws:region}:${aws:accountId}:function:${self:service}-${opt:stage, 'dev'}-generalDomainValidation"
              Payload.$: $
            Retry:
              - ErrorEquals:
                  - "States.ALL"
                IntervalSeconds: 300
                MaxAttempts: 12
                BackoffRate: 1
            End: true
      - StartAt: Primary domain validation
        States:
          Primary domain validation:
            Type: Task
            Resource: arn:aws:states:::lambda:invoke
            OutputPath: $.Payload
            Parameters:
              FunctionName: "arn:aws:lambda:${aws:region}:${aws:accountId}:function:${self:service}-${opt:stage, 'dev'}-primaryDomainValidation"
              Payload.$:  $.Records[0].body
            Retry:
              - ErrorEquals:
                  - "States.ALL"
                IntervalSeconds: 300
                MaxAttempts: 12
                BackoffRate: 1
            End: true
      - StartAt: Redirection domain validation
        States:
          Redirection domain validation:
            Type: Task
            Resource: arn:aws:states:::lambda:invoke
            OutputPath: $.Payload
            Parameters:
              FunctionName: "arn:aws:lambda:${aws:region}:${aws:accountId}:function:${self:service}-${opt:stage, 'dev'}-redirectionDomainValidation"
              Payload.$:  $.Records[0].body
            Retry:
              - ErrorEquals:
                  - "States.ALL"
                IntervalSeconds: 300
                MaxAttempts: 12
                BackoffRate: 1
            End: true
    Catch:
      - ErrorEquals:
          - States.ALL
        Next: Launch error handler
    Next: Launch success notification
  Launch success notification:
    Type: Task
    Resource: arn:aws:states:::lambda:invoke
    OutputPath: $.Payload
    Parameters:
      FunctionName: "arn:aws:lambda:${aws:region}:${aws:accountId}:function:${self:service}-${opt:stage, 'dev'}-successNotification"
      Payload.$: $
    Retry:
      - ErrorEquals:
          - Lambda.ServiceException
          - Lambda.AWSLambdaException
          - Lambda.SdkClientException
        IntervalSeconds: 2
        MaxAttempts: 6
        BackoffRate: 2
    Next: Success
    Catch:
      - ErrorEquals:
          - States.ALL
        Next: Launch error handler
  Success:
    Type: Succeed
  Launch error handler:
    Type: Task
    Resource: arn:aws:states:::lambda:invoke
    OutputPath: $.Payload
    Parameters:
      FunctionName: "arn:aws:lambda:${aws:region}:${aws:accountId}:function:${self:service}-${opt:stage, 'dev'}-failureNotification"
      Payload.$: $
    Retry:
      - ErrorEquals:
          - Lambda.ServiceException
          - Lambda.AWSLambdaException
          - Lambda.SdkClientException
        IntervalSeconds: 2
        MaxAttempts: 6
        BackoffRate: 2
    Next: Fail
  Fail:
    Type: Fail
